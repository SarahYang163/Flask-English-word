pipeline {
    agent any

    environment {
        PROJECT_DIR = '/data/sarah/Flask-English-word'
        VENV_DIR = "${PROJECT_DIR}/.venv"
        REQUIREMENTS_HASH_FILE = "${PROJECT_DIR}/.requirements_hash"
        WHEELHOUSE = "${PROJECT_DIR}/wheelhouse"
    }
    options {
        timeout(time: 10, unit: 'MINUTES') // 设置超时时间为60分钟
    }
    stages {
        stage('Checkout') {
            steps {
                // 确保目录存在
                sh "mkdir -p ${PROJECT_DIR}"
                dir("${PROJECT_DIR}") {
                        // Checkout code from Git repository
                        git url: 'git@github.com:SarahYang163/Flask-English-word.git', branch: 'master'
                    }

            }
        }

        stage('Setup Python Environment') {
            steps {
                // Create or update the virtual environment
                script {
                    if (!fileExists("${VENV_DIR}/bin/activate")) {
                        sh "virtualenv ${VENV_DIR}"
                    }
                   sh '. ${VENV_DIR}/bin/activate'

                   // 修改 4：检查 requirements.txt 是否有变化
                    def requirementsChanged = false
                    if (fileExists("${REQUIREMENTS_HASH_FILE}")) {
                        def oldHash = readFile("${REQUIREMENTS_HASH_FILE}").trim()
                        def newHash = sh(script: "md5sum ${PROJECT_DIR}/requirements.txt | awk '{ print \$1 }'", returnStdout: true).trim()
                        if (oldHash != newHash) {
                            requirementsChanged = true
                        }
                    } else {
                        requirementsChanged = true
                    }

                    if (requirementsChanged) {
                        echo "Requirements changed or first run. Installing dependencies..."
                        sh """
                            . ${VENV_DIR}/bin/activate &&
                            pip install wheel &&
                            pip wheel -r ${PROJECT_DIR}/requirements.txt -w ${WHEELHOUSE} --default-timeout=600 -i https://pypi.tuna.tsinghua.edu.cn/simple --trusted-host pypi.tuna.tsinghua.edu.cn &&
                            pip install --no-index --find-links=${WHEELHOUSE} -r ${PROJECT_DIR}/requirements.txt --default-timeout=600 &&
                            md5sum ${PROJECT_DIR}/requirements.txt | awk '{ print \$1 }' > ${REQUIREMENTS_HASH_FILE}
                        """
                    echo "Requirements changed or first run finished. Installing dependencies..."
                    }
                    else {
                        echo "Requirements not changed. Skipping installation."
                    }
                }
            }
        }

        stage('Run test.py') {
            steps {
                // Activate virtual environment and run tests
                echo "Run test start."
                sh """. ${VENV_DIR}/bin/activate && python3 ${PROJECT_DIR}/test.py"""
                echo "Run test end."
            }
        }

        stage('Build and Deploy') {
            steps {
                echo "Build and Deploy steps start."
                // Activate virtual environment and run build/deploy scripts
                sh 'pkill -f gunicorn || true'
                sh """
                . ${VENV_DIR}/bin/activate
                nohup gunicorn -w 1 -b 0.0.0.0:8089 app:app --log-level debug --access-logfile - --error-logfile - > ${PROJECT_DIR}/gunicorn.log 2>&1 &
                """
                sleep 3 // 等待gunicorn启动
                echo "Build and Deploy steps completed."
            }
        }
    }

    post {
        always {
            // Clean up
            echo "Post steps completed."
        }
    }
}
